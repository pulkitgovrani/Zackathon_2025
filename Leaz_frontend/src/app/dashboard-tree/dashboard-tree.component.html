<div *ngIf="loading" class="loading">Loading...</div>
<div *ngIf="!loading">
  <div style="margin-bottom: 1.5rem">
    <input
      type="text"
      placeholder="Search binders..."
      [(ngModel)]="searchTerm"
      (ngModelChange)="onSearchChange($event)"
      style="
        width: 100%;
        max-width: 400px;
        padding: 8px 14px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1em;
      "
    />
  </div>
  <div class="tree-container">
    <ng-container *ngFor="let tree of filteredBinderTrees">
      <ng-container
        *ngTemplateOutlet="renderBinder; context: { $implicit: tree }"
      ></ng-container>
    </ng-container>
  </div>
</div>

<ng-template #renderBinder let-node>
  <div class="binder-node">
    <div
      class="binder-label"
      cdkDropList
      [cdkDropListData]="node.documents || []"
      (cdkDropListDropped)="onDocumentDrop($event, node)"
      (cdkDropListEntered)="onDropListEntered(node)"
      [cdkDropListConnectedTo]="allDropListIds"
      [id]="'dropList-label-' + node.id"
    >
      <button
        (click)="toggleCollapse(node)"
        style="
          margin-right: 6px;
          background: none;
          border: none;
          cursor: pointer;
        "
        *ngIf="
          node.children.length > 0 ||
          (node.documents && node.documents.length > 0)
        "
        aria-label="Toggle collapse"
      >
        <span *ngIf="node.collapsed">▶</span>
        <span *ngIf="!node.collapsed">▼</span>
      </button>
      {{ node.name }}
    </div>
    <!-- Always render children container so drop lists exist in DOM -->
    <div class="children">
      <ng-container *ngFor="let child of node.children">
        <ng-container
          *ngTemplateOutlet="renderBinder; context: { $implicit: child }"
        ></ng-container>
      </ng-container>
      <div
        class="documents"
        *ngIf="node.documents && node.documents.length > 0 && !node.collapsed"
        cdkDropList
        [cdkDropListData]="node.documents || []"
        (cdkDropListDropped)="onDocumentDrop($event, node)"
        (cdkDropListEntered)="onDropListEntered(node)"
        [cdkDropListConnectedTo]="allDropListIds"
        [id]="'dropList-' + node.id"
      >
        <div
          class="document-node"
          *ngFor="let doc of node.documents"
          cdkDrag
          [cdkDragData]="doc"
        >
          {{ doc.title }}
        </div>
      </div>
    </div>
  </div>
</ng-template>
